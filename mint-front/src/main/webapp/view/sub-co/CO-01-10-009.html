<!--
	Screen ID : CO-01-10-009
	Screen NM : 인터페이스 트레킹 상세 팝업(공통) - IIP 4.0
-->

<div class="modal" id="CO-01-10-009" role="dialog">
    <div class="modal-dialog" tabindex='-1'>
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" style="padding: 15px;">
                    <span aria-hidden="true">&times;</span> <span id="bt-if-search-close" class="sr-only bt-if-search-close">Close</span>
                </button>
                <span style="float: right; font-size:15px; font-weight: bold; padding: 15px 0px 0px 0px;">
                    <a class="help-over-pannel" onclick="mint.ui.help(this, 'AP00000050','H001')"></a>
                </span>
                <div>
                    <h2><lb class="lb-30"></lb> <lb class="lb-353"></lb></h2>
                </div>
            </div>

            <!--modal-body-->
            <div class="modal-body">
                <div class="ibox-content4">

                    <div class="col-lg-12">
                        <div>
                            <h4>▶ <lb class="lb-152"></lb></h4>
                        </div>
                        <div>
                            <table class="table table-bordered">
                                <tr>
                                    <th class="thbg"><lb class="lb-153"></lb>( <lb class="lb-422"></lb> )</th>
                                    <td id="interfaceIdNm" colspan="3"></td>
                                </tr>
                                <tr>
                                    <th width="20%" class="thbg"><lb class="lb-80"></lb></th>
                                    <td width="30%" id="channelNm"></td>
                                    <th width="20%" class="thbg"><lb class="lb-81"></lb></th>
                                    <td width="30%" id="businessNm"></td>
                                </tr>
                                <tr>
                                	<th class="thbg"><lb class="lb-158"></lb></th>
                                    <td id="dataPrMethodNm"></td>
                                    <th class="thbg"><lb class="lb-155"></lb></th>
                                    <td id="dataPrDirNm"></td>
                                </tr>
                                <tr>
                                    <th class="thbg"><lb class="lb-162"></lb></th>
                                    <td id="appPrMethodNm"></td>
                                    <th class="thbg"><lb class="lb-166"></lb></th>
                                    <td id="dataFrequency"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

					<hr class="hr-space">
					<hr class="hr-space">

                    <div class="col-lg-12">
                        <div>
                            <h4>▶ <lb class="lb-180"></lb></h4>
                        </div>
                        <div>
                            <div id="systemGrid" ></div>
                        </div>
                    </div>

                    <hr class="hr-space">
                    <hr class="hr-space">

					<div class="col-lg-12">
                        <div>
							<sapn style="padding: 0px; float: left;">
								<h4> ▶ <lb class="lb-459"></lb> <lb class="lb-352"></lb></h4>
							</sapn>
							<span style="padding: 0px; float: right;">
								<span class="lable-sm" style="margin-right: 7px"><lb class="lb-459"></lb> <lb class="lb-460"></lb></span>
								<span style="margin-right: 7px"><strong><lb class="lb-89"></lb> </strong><span id="totalCnt"></span></span>
								<span style="margin-right: 7px"><strong><lb class="lb-412"></lb> </strong><span id="completeCnt"></span></span>
								<span style="margin-right: 7px"><strong><lb class="lb-476"></lb> </strong><font color="#ff0000"><span id="errorCnt"></span></font></span>
							</span>
                        </div>

                        <div style="padding:30px 0px 0px 0px;">
							<div id="nodeListGrid"></div>
                        </div>
                    </div>

                    <hr class="hr-space">
 					<hr class="hr-space">

                    <div class="col-lg-12">
                        <div class="panel blank-panel">
                            <div class="poupup-tabs-container">
                                <ul id="tab-detail-info" class="nav nav-tabs">
                                    <li class="active"><a data-toggle="tab" href="#tab-01"><lb class="lb-462">Message</lb> <lb class="lb-464">Detail</lb></a></li>
                                    <li class=""><a data-toggle="tab" href="#tab-02"><lb class="lb-463">Error</lb> <lb class="lb-464">Detail</lb></a></li>
                                    <li class="" style="display:none;"><a data-toggle="tab" href="#tab-03"><lb class="lb-32">오류</lb> <lb class="lb-465">이력</lb></a></li>
                                </ul>
                            </div>

                            <div class="panel-body">
                                <div class="tab-content">
                                   	<div id="tab-01" class="tab-pane active">
                                        <div class="col-sm-12" style="padding: 0px 2px 0px 2px">
                                            <textarea id="msg" class="well" style="padding: 10px 10px 10px 10px; width:100%; height: 100px; overflow-y:auto;" readonly></textarea>
                                        </div>
                                    </div>
                                    <div id="tab-02" class="tab-pane">
                                        <div class="col-sm-12" style="padding: 0px 2px 0px 2px">
                                        	<textarea id="errorMsg" class="alert alert-danger" style="padding: 10px 10px 10px 10px; width:100%; height: 100px; overflow-y:auto;" readonly></textarea>
                                        </div>
                                    </div>
                                    <div id="tab-03" class="tab-pane">
	                                    <div class="col-sm-12" style="padding: 0px 2px 0px 2px">
	                                    	<div id="problemInterfaceListGrid"></div>
	                                    </div>
                                    </div>
                                </div><!--tab-content end-->
                            </div> <!--panel-body-->
                        </div><!--panel blank-panel-->
                    </div><!--col-lg-12 end-->
                </div>
            </div>

            <!--modal-footer-->
            <div class="modal-footer-original" style="clear: both">
                <button id="btnClose" type="button" class="btn btn-danger btn-outline btnClose" data-dismiss="modal"><i class="fa fa-ban"></i> Close </button>
            </div>
            <!--modal-footer END-->
        </div>
    </div>
    <!--modal-content animated fadeIn END-->
</div>
<!-- modal-dialog END-->



<script>
$(document).ready(function() {
    //=======================================================================
    //(1) function 및 variable scope 설정 :: (메인은 main, 팝업 및 서브는 sub)
    //=======================================================================
    screenName = "CO-01-10-009";
    $.extend({
        sub : {
            //=======================================================================
            // (2) Screen 에서 사용할 variable 정의
            //=======================================================================
			detailKey : '',
            //=======================================================================
            // (3) Screen 에서 사용할 function 정의
            //=======================================================================


            //-----------------------------------------------------------------------
            // Description :: 화면 초기화
            //-----------------------------------------------------------------------
            fn_init : function() {
                try {
                    mint.init('$.sub.fn_initCallback',{isDraggable:false});
                } catch( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_init"});
                }
            },//end fn_init()

            //-----------------------------------------------------------------------
            // Description :: 화면 초기화 콜백
            //-----------------------------------------------------------------------
            fn_initCallback : function() {
                try{
                	$.sub.fn_initGridSystem();
                	$.sub.fn_initGridNode();

                	$.sub.detailKey = mint.common.getScreenParam('detailKey');

                	if( !mint.common.isEmpty($.sub.detailKey) ) {
                		$.sub.fn_getInterfaceInfo();
                		$.sub.fn_getTrackingDetail();
                	}

                } catch( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_initCallback"});
                }
            },

            //-----------------------------------------------------------------------
            // Description :: fn_initGridSystem
            //-----------------------------------------------------------------------
            fn_initGridSystem : function() {
                try{
            		$("#systemGrid").kendoGrid({
						dataSource: {
							data: [],
							pageSize: mint.ui.getPageSizesS({'currentPage' : true})
						},
						selectable: true,
						scrollable: true,
						resizable: true,
						sortable: true,
						columns: [
							{
								field: "nodeTypeNm",
								title: mint.label.getLabel('lb-494'), // 구분
								width:"80px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "<span title='${nodeTypeNm}'>${nodeTypeNm}</span>",
							},
							{
								field: "systemNm",
								title: mint.label.getLabel('lb-82'), // 시스템
								width: "180px;",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "<span title='${systemNm}(${systemCd})'>${systemNm}(${systemCd})</span>",
							},
							{
								field: "resourceNm",
								title: mint.label.getLabel('lb-86'), // Application
								width:"80px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "<span title='${resourceNm}'>${resourceNm}</span>",
							},
							{
								field: "service",
								title: mint.label.getLabel('lb-87'), // 메시지
								width:"200px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "<span title='${service}'>${service}</span>",
							},
							{field:"systemCd", hidden:true},
						],
						dataBound: function (e) {
							if('undefined' != typeof $("#systemGrid").data()) {
								if(0 == $("#systemGrid").data().kendoGrid.dataSource.view().length) {
						    		$("#systemGrid").children(".k-grid-content").height('50');
						    	} else {
						    		$("#systemGrid").children(".k-grid-content").height('auto');
						    	}
							}
					    }

                    });
                } catch( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_initGridSystem"});
                }
            },

            //-----------------------------------------------------------------------
            // Description :: fn_initGrid
            //-----------------------------------------------------------------------
            fn_initGridNode : function() {
                try{
					$("#nodeListGrid").kendoGrid({
						dataSource: {
							data: [],
							pageSize: mint.ui.getPageSizesS({'currentPage' : true})
						},
						sortable: true,
						selectable: true,
						resizable: true,
						columns: [
							{
								field: "processId",
								title: mint.label.getLabel('lb-459'), // 노드
								width: "150px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							},
							{
								field: "nodeType",
								title: mint.label.getLabel('lb-469'), // 송/수신구분
								width: "100px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							},
							{
								field: "hostId",
								title: mint.label.getLabel('lb-470') + mint.label.getLabel('lb-422'), // 호스트ID
								width: "150px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							},
							{
								field: "startDate",
								title: mint.label.getLabel('lb-241'), // 시작시간
								width: "150px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template : '#=$.sub.fn_changeTime(startDate)#'
							},
							{
								field: "endDate",
								title: mint.label.getLabel('lb-242'), // 종료시간
								width: "150px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template : '#=$.sub.fn_changeTime(endDate)#'
							},
							{
								field: "status",
								title: mint.label.getLabel('lb-473'), // 상태
								width: "70px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "#=$.sub.fn_setColor(status)#",
							},
							{
								field: "dataAmt",
								title: mint.label.getLabel('lb-474'), // 데이터 사이즈
								width: "110px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								},
								template: "#=mint.common.addComma(dataAmt)#"
							},
							{
								field: "cmp",
								title: mint.label.getLabel('lb-475'), // 압축여부
								width: "70px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							},
							{
								field: "directory",
								title: mint.label.getLabel('lb-899'), // 디렉토리
								width: "250px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							},
							{
								field: "fileNm",
								title: mint.label.getLabel('lb-916'), // 파일명
								width: "250px",
								headerAttributes: {
									style: "text-align: center"
								},
								attributes: {
									style: "text-align: center"
								}
							}
						],
                        dataBound: function(e) {
							if('undefined' != typeof $("#nodeListGrid").data()) {
								if(0 == $("#nodeListGrid").data().kendoGrid.dataSource.view().length) {
						    		$("#nodeListGrid").children(".k-grid-content").height('50');
						    	} else {
						    		$("#nodeListGrid").children(".k-grid-content").height('auto');
						    	}
							}

							//-----------------------------------------------------------------------
							// Node Count 처리
							//-----------------------------------------------------------------------
							var totalCnt = 0;
							var completeCnt = 0;
							var errorCnt = 0;

							var items = e.sender.dataItems();
							if( items.length > 0 ) {
								for(var i = 0; i < items.length; i++ ) {
									var status = items[i].status;
									if( status == "99" ) {
										errorCnt++;
									} else {
										completeCnt++;
									}
								}
							}

		                    totalCnt = completeCnt + errorCnt;

		                    $("#totalCnt").html(totalCnt);
		                    $("#completeCnt").html(completeCnt);
		                    $("#errorCnt").html(errorCnt);

                        }
                    });
                } catch( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_initGridNode"});
                }
            },

            //-----------------------------------------------------------------------
            // Description :: fn_getInterfaceInfo
            //-----------------------------------------------------------------------
            fn_getInterfaceInfo : function() {
            	try {

            		if( mint.common.isEmpty($.sub.detailKey.interfaceId) ) {
            			return;
            		}

            		mint.callService( null, 'CO-01-00-009', 'REST-R02-CO-01-00-008',
            				function( jsonData ) {
								$.sub.fn_setInterfaceInfo( jsonData );
            				},
            				{ errorCall : true, params : { interfaceId : $.sub.detailKey.interfaceId } }
            		);

            	} catch ( e ) {
            		mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_getInterfaceInfo"});
            	}
            },

            //-----------------------------------------------------------------------
            // Description :: fn_setInterfaceInfo
            //-----------------------------------------------------------------------
            fn_setInterfaceInfo : function(jsonData) {
                try {
                	if( !mint.common.isEmpty(jsonData) ) {
                        //-----------------------------------------------------------------------
                        // 기본 정보
                        //-----------------------------------------------------------------------
						$("#interfaceIdNm").html( jsonData.interfaceNm + "( " + jsonData.integrationId + " )");
                        if( !mint.common.isEmpty( jsonData.channel ) ) {
                            $("#channelNm").html( jsonData.channel.channelNm );
                        }
                        if( !mint.common.isEmpty( jsonData.businessList ) && jsonData.businessList.length > 0 ) {
                            $("#businessNm").html( jsonData.businessList[0].businessNm );
                        }
                        $("#appPrMethodNm").html( jsonData.appPrMethodNm );
                        $("#dataPrDirNm").html(  jsonData.dataPrDirNm );
                        $("#dataFrequency").html( jsonData.dataFrequency );
                        $("#dataPrMethodNm").html( jsonData.dataPrMethodNm );

                        //-----------------------------------------------------------------------
                        // 연계 시스템
                        //-----------------------------------------------------------------------
                        if( !mint.common.isEmpty(jsonData.systemList) ) {
                    		var dataSource = new kendo.data.DataSource({
								data: jsonData.systemList,
								schema: {
									model: {
										fields: {
											nodeTypeNm: {type: "String"},
											systemNm: {type: "String"},
											systemCd: {type: "String"},
											resourceNm: {type: "String"},
											service: {type: "String"}
										}
									}
								},
								page:1,
								pageSize:mint.ui.getPageSizesS({'currentPage' : true}),
								sort: { field: "nodeTypeNm", dir: "asc" }
      						});
      						$("#systemGrid").data("kendoGrid").setDataSource(dataSource);
                        }
                    }
                } catch ( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_setInterfaceInfo"});
                }
            },

            //-----------------------------------------------------------------------
            // Description :: fn_getTrackingDetail
            //-----------------------------------------------------------------------
            fn_getTrackingDetail : function() {
            	try {
            		var requestObject = new Object();
            		mint.callService(requestObject, screenName, 'REST-R02-OP-01-10',
            				function( jsonData ) {
            					$.sub.fn_setTrackingDetail( jsonData );
            				},
            				{ errorCall : true, notificationView : false, params : {integrationId: $.sub.detailKey.integrationId, trackingDate: $.sub.detailKey.trackingDate, orgHostId: $.sub.detailKey.orgHostId} }
            		);
            	} catch ( e ) {
            		mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_getTrackingDetail"});
            	}
            },

            //-----------------------------------------------------------------------
            // Description :: fn_setTrackingDetail
            //-----------------------------------------------------------------------
            fn_setTrackingDetail : function(jsonData) {
            	try {
            		var dataSource = new kendo.data.DataSource({
						data: jsonData,
						page:1,
						pageSize:mint.ui.getPageSizesS({'currentPage' : true})
					});
					$("#nodeListGrid").data("kendoGrid").setDataSource(dataSource);

            	} catch ( e ) {
            		mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_setTrackingDetail"});
            	}
            },

            //-----------------------------------------------------------------------
            // Description :: 하단 msg detail과 error msg를 세팅한다.
            //-----------------------------------------------------------------------
            fn_setMsg : function(data) {
                try {
                	var grid = $("#nodeListGrid").data("kendoGrid");
                    var selectedItem = grid.dataItem(grid.select());

                    status   = selectedItem.status;

                    $("#msg").val( mint.common.isEmpty( selectedItem.msgToString ) ? '' : selectedItem.msgToString );
                    $("#errorMsg").val( mint.common.isEmpty( selectedItem.errorMsg ) ? '' : selectedItem.errorMsg );

                    if( selectedItem.status === '99' ) {
                    	$('#tab-detail-info a:eq(1)').tab('show');
                    } else {
                    	$('#tab-detail-info a:eq(0)').tab('show');
                    }
                } catch ( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_setMsg"});
                }
            },

            //-----------------------------------------------------------------------
            // Description :: node list의 상태 정보 색깔을 변경한다.
            //-----------------------------------------------------------------------
            fn_setColor : function(val) {
                try {
                	var result = "";
                    if (val && val != null && val == "99") {
                        result = "<b style='color:red'>" + "오류" + "</b>";
                    } else if (val && val != null && val == "01") {
                        result = "완료";
                    } else {
                        result = "완료";
                    }
                    return result;
                } catch ( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_setColor"});
                }
            },

          	//-----------------------------------------------------------------------
            // Description :: 그리드 시간 설정
            //-----------------------------------------------------------------------
            fn_changeTime : function(val) {
                try {
                    if(val != null && val != "") {
                        var str = val.substring(0, 14);
                        var returnVal = str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8) + " " + str.substring(8, 10) + ":" + str.substring(10, 12) + ":" + str.substring(12, 14);
                        return returnVal;
                    } else {
                    	return "";
                    }
                } catch( e ) {
                    mint.common.errorLog(e, {"screenName" : screenName, "fnName" : "$.sub.fn_changeTime"});
                }
            }
        }
    });


    //=======================================================================
    // (4) 이벤트 핸들러 정의
    //=======================================================================
	//-----------------------------------------------------------------------
	// Description :: 노드리스트 그리드 Click 이벤트 (상세 조회)
	//-----------------------------------------------------------------------
    $('#nodeListGrid').on("click", "tr.k-state-selected", function(e) {
        $.sub.fn_setMsg();
    });

    //=======================================================================
    // (5) 기타 Function 정의
    //=======================================================================

    //=======================================================================
    // (6) 화면 로딩시 실행할 항목 기술
    //=======================================================================
    $.sub.fn_init();
    mint.label.attachLabel(null);
});
</script>