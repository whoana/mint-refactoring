======================================================================================================
- fetch-20191216-01
------------------------------------------------------------------------------------------------------
- fetch id: fetch-20191216-01
- author  : whoana
- todo    : netstat 로그수집 기능 추가를 위해 아래 절차를 진행하세요.
- 제약조건  : linux netstat 명령에 대해서만 파서를 구현한 상태임.
------------------------------------------------------------------------------------------------------
1.내  용 : netstat 로그수집 기능 추가

2.절  차 :
	-------------------------------------------------------------------------------------------------- 
	1) 테이블 수정
	-------------------------------------------------------------------------------------------------- 
		서버 테이블 IP 컬럼 길이 확장 10 --> 50
		ALTER TABLE TIM0201 MODIFY (IP VARCHAR(50));

	-------------------------------------------------------------------------------------------------- 
	2) mint 서비스 추가 
	-------------------------------------------------------------------------------------------------- 
		변경된 mint-database.jar, mint-websocket.jar를 패치를 적용한 mint-front를 재배포하고 IIP 서버를 재기동하다.  		
		
		[mint-database 변경 내용] 
		pep.per.mint.database.service.op.LocalCmdLogService 추가 
		 
		[mint-websocket 변경 내용] 
		pep.per.mint.websocket.controller.AgentChannelController 수정
		pep.per.mint.websocket.env.WebsocketEnvironments 수정
		pep.per.mint.websocket.env.Variables 수정
				
	-------------------------------------------------------------------------------------------------- 
	3) application.properties 수정
	--------------------------------------------------------------------------------------------------  
		{IIPAGENT_HOME}/application.properties 내용을 전달된 파일로 갱신 또는 내용을 수정한다.
		기존 내용에서 추가된 내용은 아래와 같다.
		 
		[application.properties 추가 내용]		
		iip.agent.use.module.netstat=Y  --------------------- netstat 사용 여부(Y/N)
		iip.agent.use.module.netstat.cmd=netstat -antp  ----- netstat linux 명령(리눅스만 구현됨, 타 OS는 불가능) 
		iip.agent.use.module.netstat.delay=10  -------------- netstat 호출 주기 (초)
		iip.agent.use.module.netstat.list.check.delay=60  --- netstat 체크 대상 서버 리스트 갱신 주기(초)

	--------------------------------------------------------------------------------------------------
	4) mint-common.jar 라이브러리 업데이트
	-------------------------------------------------------------------------------------------------- 		
		{IIPAGENT_HOME}/lib/mint-common-3.0.0.jar 를 최신 버전으로 업데이트 한다.		
		netstat 로그 수집을 위해 변경된 클래스는 아래와 같다.
		
		[mint-common 변경 클래스 ]		
		pep.per.mint.common.msg.handler.ServiceCodeConstant
		pep.per.mint.common.msg.handler.ItemDeserializer
	
	--------------------------------------------------------------------------------------------------
	5) mint-agent.jar 최신 라이브러리 배포
	--------------------------------------------------------------------------------------------------
		운영/개발 중인 mint-front 웹애플리케이션에 배포된 mint-agent-3.0.0.jar 를 최신버전으로 빌드하여 배포한다.
		mint-agent-3.0.0.jar 배포 위치는 아래와 같다.
		
		[mint-agent-3.0.0.jar 배포 위치]  	
		{mint document root}/agent/deploy_v3.1/lib/mint-agent-3.0.0.jar
	
	--------------------------------------------------------------------------------------------------	
	6) netstat check list 등록 
	--------------------------------------------------------------------------------------------------
		IIP 로그인 후 
			관리자 > 기초코드관리 > 서버관리 프로그램에서 네트워크 상태체크를 위한 서버 정보를 등록한다.
		등록할 필수 값은 아래와 같다.
		
		[서버등록 필수 값]
			서버명 
			서버코드 
			호스트명 
			IP		  (클라이언트 : xxx.xxx.xxx.xxx:port, 서버 : port) 
			H/W설치위치 ( 서버 : 1, 클라이언트 2) 
		
		서버리스트 외에도 
			모니터링 > 환경설정 > 시스템 및 EAI통신모듈 프로그램에 네트워크 상태 체크를 수행할 IIP 에이전트 정보가 등록되어 있는지 확인한다.

	--------------------------------------------------------------------------------------------------			
	7) IIP 에이전트 실행 및 로그 확인
	-------------------------------------------------------------------------------------------------- 
		1) ~ 5) 번 항목 완료 후 IIP 에이전트를 실행 또는 재실행 한다.
		실행이 완료된 후 로그 상에서 아래 내용이 설정한 주기에 따라 기록되는지 확인한다.  
		
		[IIP에이전트 로그 확인]
		tail -f {IIPAGENT_HOME}/log/iipagent.log
		
			2019-12-16 09:17:10.968  INFO  2752 [anagementScheduler-2]      p.p.m.a.c.AgentController: 995 - netstat log size [9] send. 
	
	--------------------------------------------------------------------------------------------------			
	8) 테이블 및 대시보드 화면 확인
	-------------------------------------------------------------------------------------------------- 
		TOP0818 네크워크채널상태관리 테이블에 MOD_DATE 컬럼 값 기준 현재 시간으로 설정된 주기로 체크 대상 서버의 상테가 업데이트되는지 확인해 본다.		
		모니터링 > 대시보드 > 연계기관 통신상태 패널상에 네크워크 상태에 문제있는 서버 리스트가 표현되는 지 확인해 본다.
		
		[점검 SQL]   

		-- 서버 리스트 조회
		select SERVER_ID as "serverId", IP as "ip" from TIM0201 where HW_INST_POSITION IN ('1','2','3');

 
		-- 상태 리스트 조회   
			-- 비정상 건 조회 
		 	SELECT 
		 	     '채널 비정상 --> '|| b.SERVER_NM||'['||b.SERVER_CD||']'||
		 	     '(주소 : '||b.IP||', 상태 : '||a.STATE||', 점검: '||
		 	     TO_char(TO_TIMESTAMP(nvl(A.MOD_DATE, A.REG_DATE),'YYYYMMDDHH24MISSFF3'),'YYYY/MM/DD HH24:MI:SS')||')' AS CHECK_RESULT
		  	  FROM TOP0818 a 
		INNER JOIN TIM0201 b
		        ON a.SERVER_ID = b.SERVER_ID
		       AND b.DEL_YN = 'N'
		       AND a.STATE NOT IN ('ESTABLISHED','LISTEN')    
		UNION ALL
		    SELECT '-------------------------------------------------------------------------------------------------' FROM dual
		UNION ALL
			-- 정상 건 조회 
		    SELECT 
				'채널 정상 --> '|| b.SERVER_NM||'['||b.SERVER_CD||']'||
				'(주소 : '||b.IP||', 상태 : '||a.STATE||', 점검: '||
				TO_char(TO_TIMESTAMP(nvl(A.MOD_DATE, A.REG_DATE),'YYYYMMDDHH24MISSFF3'),'YYYY/MM/DD HH24:MI:SS')||')' AS CHECK_RESULT
		  	  FROM TOP0818 a 
		INNER JOIN TIM0201 b
		        ON a.SERVER_ID = b.SERVER_ID
		       AND b.DEL_YN = 'N'
		       AND a.STATE IN ('ESTABLISHED','LISTEN');

3.추가 설명 
	네크워크 상태 수집 프로세스	
	
	                     websocket(WS0044)
	(IIP 서버) <------------------------------------ (IIP 에이전트) 
	                                                서버리스트 요청 
	서버리스트 응답                                     서버리스트 업데이트  
	
	                     websocket(WS0043)
	(IIP 서버) <------------------------------------ (IIP 에이전트) 
	 로그적재                                          netstat 실행 및 파싱 및 로그 전송 
	

------------------------------------------------------------------------------------------------------